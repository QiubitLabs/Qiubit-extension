<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Octra DEX - Test dApp</title>
    <style>
        :root {
            --primary: #00ff9d;
            --primary-dim: #00ff9d20;
            --bg: #0f1114;
            --card: #1a1d24;
            --text: #ffffff;
            --text-secondary: #9ca3af;
            --border: #2d3342;
            --error: #ef4444;
            --success: #10b981;
            --purple: #8b5cf6;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1000px;
            margin-bottom: 40px;
            padding: 20px 0;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(to right, #00ff9d, #00b8ff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--primary);
            color: #000;
            border: none;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 255, 157, 0.3);
        }

        .btn-purple {
            background: var(--purple);
            color: #fff;
            border: none;
        }

        .btn-purple:hover {
            opacity: 0.9;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .cards-container {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 1000px;
            width: 100%;
        }

        .main-card {
            background: var(--card);
            padding: 24px;
            border-radius: 24px;
            width: 100%;
            max-width: 480px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            align-items: center;
        }

        .card-header h3 {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badge {
            background: var(--primary-dim);
            color: var(--primary);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
        }

        .badge-purple {
            background: rgba(139, 92, 246, 0.2);
            color: var(--purple);
        }

        .input-group {
            background: var(--bg);
            padding: 16px;
            border-radius: 16px;
            border: 1px solid transparent;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }

        .input-group:focus-within {
            border-color: var(--primary);
        }

        .input-label {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        input,
        textarea {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 16px;
            width: 100%;
            outline: none;
            resize: vertical;
        }

        textarea {
            min-height: 80px;
            font-family: monospace;
        }

        .token-badge {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .arrow-divider {
            display: flex;
            justify-content: center;
            margin: -8px 0;
            position: relative;
            z-index: 10;
        }

        .arrow-btn {
            background: var(--card);
            border: 4px solid var(--bg);
            border-radius: 12px;
            padding: 8px;
            color: var(--text);
        }

        .logs {
            margin-top: 40px;
            width: 100%;
            max-width: 1000px;
            background: #000;
            padding: 20px;
            border-radius: 12px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .log-item {
            margin-bottom: 4px;
            word-break: break-all;
        }

        .log-success {
            color: var(--success);
        }

        .log-error {
            color: var(--error);
        }

        .log-info {
            color: var(--text-secondary);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            background: var(--card);
            padding: 6px 12px;
            border-radius: 20px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--error);
        }

        .dot.connected {
            background: var(--success);
        }

        .result-box {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            margin-top: 12px;
            font-family: monospace;
            font-size: 11px;
            word-break: break-all;
            max-height: 150px;
            overflow-y: auto;
        }

        .result-box.valid {
            border-color: var(--success);
        }

        .result-box.invalid {
            border-color: var(--error);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
    </style>
</head>

<body>
    <div class="navbar">
        <div class="logo">Octra DEX</div>
        <div style="display: flex; gap: 12px;">
            <div class="status-badge">
                <div class="dot" id="networkDot"></div>
                <span id="networkName">Disconnected</span>
            </div>
            <button class="btn btn-primary" id="connectBtn" onclick="toggleConnect()">Connect Wallet</button>
        </div>
    </div>

    <div class="cards-container">
        <!-- Transfer Card -->
        <div class="main-card">
            <div class="card-header">
                <h3>Transfer <span class="badge">OCT</span></h3>
            </div>

            <div class="input-group">
                <div class="input-label">
                    <span>Amount</span>
                    <span>Balance: <span id="octBalance">0.00</span></span>
                </div>
                <div class="input-row">
                    <input type="number" id="amountIn" placeholder="0" value="0.01" step="0.001">
                    <div class="token-badge">
                        <span>OCT</span>
                    </div>
                </div>
            </div>

            <div class="arrow-divider">
                <div class="arrow-btn">-></div>
            </div>

            <div class="input-group">
                <div class="input-label">
                    <span>Recipient Address</span>
                </div>
                <div class="input-row">
                    <input type="text" placeholder="oct..." id="recipientAddr" style="font-size: 14px;">
                </div>
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-top: 16px; padding: 16px; font-size: 16px;"
                id="transferBtn" onclick="handleTransfer()" disabled>
                Connect Wallet
            </button>

            <div class="info-row">
                <span>Network Fee</span>
                <span>~0.002 OCT</span>
            </div>
        </div>

        <!-- Sign Message Card -->
        <div class="main-card">
            <div class="card-header">
                <h3>Sign Message <span class="badge badge-purple">OSM-1</span></h3>
            </div>

            <div class="input-group">
                <div class="input-label">
                    <span>Message to Sign</span>
                </div>
                <textarea id="signMessage" placeholder="Enter message to sign...">Hello from Octra DEX!</textarea>
            </div>

            <div class="input-group">
                <div class="input-label">
                    <span>Domain (auto-filled)</span>
                </div>
                <div class="input-row">
                    <input type="text" id="signDomain" readonly style="color: var(--text-secondary);">
                </div>
            </div>

            <button class="btn btn-purple" style="width: 100%; margin-top: 16px; padding: 16px; font-size: 16px;"
                id="signBtn" onclick="handleSignMessage()" disabled>
                Connect to Sign
            </button>

            <div id="signResult" class="result-box" style="display: none;"></div>
        </div>
    </div>

    <div class="logs" id="consoleLogs">
        <div class="log-item log-info">> Ready to connect...</div>
    </div>

    <script>
        // --- Logger ---
        const logger = document.getElementById('consoleLogs');
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `log-item log-${type}`;
            div.textContent = `> ${msg}`;
            logger.prepend(div);
        }

        // Init domain field
        document.getElementById('signDomain').value = window.location.origin;

        // --- State ---
        let isConnected = false;
        let userAddress = null;

        // --- Wallet Logic ---

        async function toggleConnect() {
            if (isConnected) {
                isConnected = false;
                userAddress = null;
                updateUI();
                return;
            }

            const provider = window.octra || window.qiubit;
            if (!provider) {
                log('Qiubit Wallet not found! Please install the extension.', 'error');
                return;
            }

            try {
                log('Connecting to wallet...');
                const result = await provider.connect();

                userAddress = result.selectedAddress || result.accounts[0];

                // Step 2: Auto-Sign Message for Login (Like MetaMask/OKX)
                log('Connection authorized. Signing login message...');
                await provider.signMessage({
                    message: `Login to Octra DEX\n\nAddress: ${userAddress}\nTime: ${new Date().toISOString()}`,
                    domain: window.location.origin,
                    nonce: crypto.randomUUID()
                });

                isConnected = true;
                log(`Login successful: ${userAddress}`, 'success');
                updateUI();
                refreshBalance();

            } catch (err) {
                log(`Connection failed: ${err.message || err}`, 'error');
                isConnected = false;
                updateUI();
            }
        }

        async function refreshBalance() {
            const provider = window.octra || window.qiubit;
            if (!provider || !isConnected) return;

            try {
                const bal = await provider.getBalance();
                const balEl = document.getElementById('octBalance');

                // Show raw value in title for precision, formatted in text
                balEl.textContent = bal.formatted || '0.00';
                balEl.title = `Raw: ${bal.balance} units`;

                log('Balance updated from network', 'info');
            } catch (err) {
                console.warn('Silent balance refresh failed');
            }
        }

        // --- Transfer ---
        async function handleTransfer() {
            const provider = window.octra || window.qiubit;
            const amount = document.getElementById('amountIn').value;
            const recipient = document.getElementById('recipientAddr').value;

            if (!recipient || !recipient.startsWith('oct')) {
                log('Please enter a valid recipient address (starts with "oct")', 'error');
                return;
            }

            try {
                // Step 1: Sign Authorize Message
                log(`Authorizing transfer of ${amount} OCT...`);
                await provider.signMessage({
                    message: `Authorize Transfer\n\nAmount: ${amount} OCT\nTo: ${recipient}\nNetwork: Octra Testnet`,
                    domain: window.location.origin
                });
                log('Transfer authorized via signature', 'success');

                // Step 2: Send Transaction
                log('Broadcasting transaction...');
                const txParams = {
                    to: recipient,
                    amount: amount,
                    message: "Transfer via Octra DEX"
                };

                const result = await provider.sendTransaction(txParams);

                if (result) {
                    log(`Transaction Sent! Hash: ${result.txHash || 'Pending'}`, 'success');
                    // Refresh balance several times to catch update
                    setTimeout(refreshBalance, 2000);
                    setTimeout(refreshBalance, 5000);
                    setTimeout(refreshBalance, 10000);
                }

            } catch (err) {
                log(`Transfer failed: ${err.message || err}`, 'error');
            }
        }

        // --- Sign Message (OSM-1) ---
        async function handleSignMessage() {
            const provider = window.octra || window.qiubit;
            const message = document.getElementById('signMessage').value;
            const resultBox = document.getElementById('signResult');

            if (!message.trim()) {
                log('Please enter a message to sign', 'error');
                return;
            }

            try {
                log('Requesting message signature (OSM-1)...');

                // Create OSM-1 payload
                const payload = {
                    version: 'OSM-1',
                    message: message,
                    address: userAddress,
                    domain: window.location.origin,
                    nonce: crypto.randomUUID(),
                    timestamp: Date.now()
                };

                log(`Payload: ${JSON.stringify(payload).substring(0, 80)}...`);

                const response = await provider.signMessage(payload);

                if (response && response.signature) {
                    log('Message signed successfully!', 'success');

                    // Display result
                    resultBox.style.display = 'block';
                    resultBox.className = 'result-box valid';
                    resultBox.innerHTML = `
                        <div><strong>Signature:</strong></div>
                        <div style="margin: 4px 0; color: var(--success);">${response.signature.substring(0, 60)}...</div>
                        <div style="margin-top: 8px;"><strong>Public Key:</strong></div>
                        <div style="color: var(--text-secondary);">${response.publicKey || 'N/A'}</div>
                        <div style="margin-top: 8px;"><strong>Address:</strong></div>
                        <div style="color: var(--text-secondary);">${response.address}</div>
                    `;

                    log(`Signature: ${response.signature.substring(0, 40)}...`, 'success');
                }

            } catch (err) {
                log(`Sign Failed: ${err.message || err}`, 'error');
                resultBox.style.display = 'block';
                resultBox.className = 'result-box invalid';
                resultBox.textContent = `Error: ${err.message || err}`;
            }
        }

        function updateUI() {
            const btn = document.getElementById('connectBtn');
            const transferBtn = document.getElementById('transferBtn');
            const signBtn = document.getElementById('signBtn');
            const dot = document.getElementById('networkDot');
            const netName = document.getElementById('networkName');

            if (isConnected) {
                btn.textContent = userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
                btn.classList.replace('btn-primary', 'btn');
                transferBtn.disabled = false;
                transferBtn.textContent = 'Transfer';
                signBtn.disabled = false;
                signBtn.textContent = 'Sign Message';
                dot.classList.add('connected');
                netName.textContent = 'Octra Testnet';
            } else {
                btn.textContent = 'Connect Wallet';
                btn.classList.add('btn-primary');
                transferBtn.disabled = true;
                transferBtn.textContent = 'Connect Wallet';
                signBtn.disabled = true;
                signBtn.textContent = 'Connect to Sign';
                dot.classList.remove('connected');
                netName.textContent = 'Disconnected';
            }
        }

        // Auto-detect wallet on load
        window.addEventListener('load', () => {
            if (window.octra || window.qiubit) {
                log('Wallet detected. Ready.');
            }
        });

        // Auto-refresh balance every 10 seconds when connected
        setInterval(() => {
            if (isConnected) {
                refreshBalance();
            }
        }, 10000);

    </script>
</body>

</html>